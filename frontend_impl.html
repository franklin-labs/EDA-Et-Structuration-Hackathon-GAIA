<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTransition - Portail Conseiller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        #sidebar {
            width: 280px;
            background-color: #212529;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        #sidebar .nav-link {
            color: rgba(255,255,255,0.75);
            margin-bottom: 10px;
            border-radius: 8px;
        }
        #sidebar .nav-link:hover, #sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        #sidebar .brand {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
        }
        
        /* MAIN CONTENT */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* PERPLEXITY-STYLE CHAT & WORKSPACE SPLIT */
        .split-view {
            display: flex;
            height: 100%;
        }
        
        .chat-pane {
            width: 450px;
            border-right: 1px solid #e9ecef;
            background: white;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .workspace-pane {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f4f6f8;
        }
        
        /* CHAT COMPONENTS */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        .chat-message {
            margin-bottom: 20px;
        }
        .chat-user {
            text-align: right;
        }
        .chat-user .bubble {
            background-color: #f1f3f4;
            display: inline-block;
            padding: 10px 15px;
            border-radius: 15px 15px 0 15px;
            max-width: 85%;
        }
        .chat-bot .bubble {
            background-color: transparent;
            text-align: left;
            max-width: 100%;
        }
        .reasoning-steps {
            font-size: 0.85rem;
            color: #6c757d;
            border-left: 2px solid #dee2e6;
            padding-left: 10px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        .sources-list {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .source-chip {
            font-size: 0.75rem;
            background: #e8f0fe;
            color: #1967d2;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid #d2e3fc;
        }
        .source-chip:hover {
            background: #d2e3fc;
        }
        .action-btn {
            margin-top: 5px;
            font-size: 0.85rem;
        }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="brand">
            <i class="bi bi-flower1 me-2 text-success"></i> AgriTransition
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" onclick="showView('dashboard')"><i class="bi bi-grid me-2"></i>Tableau de Bord</a>
            <a class="nav-link" onclick="showView('simulation')"><i class="bi bi-sliders me-2"></i>Simulateur</a>
            <a class="nav-link" onclick="showView('clients')"><i class="bi bi-people me-2"></i>Mes Clients</a>
            <a class="nav-link" onclick="showView('docs')"><i class="bi bi-book me-2"></i>Ressources</a>
        </nav>
        <div class="mt-auto">
            <a class="nav-link" href="#"><i class="bi bi-gear me-2"></i>Paramètres</a>
            <div class="d-flex align-items-center mt-3 p-2 bg-dark rounded">
                <div class="avatar bg-secondary rounded-circle me-2" style="width:30px;height:30px;"></div>
                <small>Conseiller #42</small>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content">
        
        <!-- VIEW: DASHBOARD (Simple view) -->
        <div id="view-dashboard" class="p-4" style="overflow-y: auto;">
            <h3 class="mb-4">Vue d'ensemble</h3>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card p-4 border-0 shadow-sm">
                        <h6 class="text-muted">Agriculteurs Suivis</h6>
                        <h2 id="dash-total-farmers">--</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-4 border-0 shadow-sm">
                        <h6 class="text-muted">Visites ce mois</h6>
                        <h2 id="dash-visits">--</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-4 border-0 shadow-sm">
                        <h6 class="text-muted">Potentiel Gain CO2</h6>
                        <h2 id="dash-carbon" class="text-success">--</h2>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold">Dernières Activités</div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead><tr><th>Ferme</th><th>Date</th><th>Statut</th><th>Action</th></tr></thead>
                        <tbody>
                            <tr><td>GAEC des Lilas</td><td>23/02</td><td><span class="badge bg-warning text-dark">En cours</span></td><td><button class="btn btn-sm btn-light" onclick="showView('simulation')">Reprendre</button></td></tr>
                            <tr><td>Ferme du Val</td><td>21/02</td><td><span class="badge bg-success">Validé</span></td><td><button class="btn btn-sm btn-light">Voir</button></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: SIMULATION (Split View) -->
        <div id="view-simulation" class="split-view" style="display: none;">
            
            <!-- LEFT: CHAT PANE (Perplexity Style) -->
            <div class="chat-pane">
                <div class="p-3 border-bottom bg-light">
                    <strong><i class="bi bi-stars text-primary me-2"></i>Assistant Expert</strong>
                </div>
                
                <div id="chat-history" class="chat-history">
                    <!-- Welcome Message -->
                    <div class="chat-message chat-bot">
                        <div class="bubble">
                            Bonjour ! Je suis prêt à analyser la ferme. Vous pouvez utiliser le simulateur à droite, ou me demander d'optimiser un paramètre (ex: "Augmente l'autonomie à 80%").
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control border-0 bg-light" placeholder="Poser une question technique..." onkeypress="handleEnter(event)">
                        <button class="btn btn-light text-primary" onclick="sendMessage()"><i class="bi bi-arrow-up-circle-fill fs-4"></i></button>
                    </div>
                    <small class="text-muted mt-2 d-block text-center" style="font-size: 0.7rem;">L'IA peut faire des erreurs. Vérifiez les sources.</small>
                </div>
            </div>

            <!-- RIGHT: WORKSPACE PANE -->
            <div class="workspace-pane">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Simulateur Systémique</h4>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-share"></i> Partager</button>
                        <button class="btn btn-primary btn-sm"><i class="bi bi-save"></i> Enregistrer</button>
                    </div>
                </div>

                <!-- FORMULAIRE RAPIDE -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">Configuration Ferme</h6>
                        <form id="farmForm" class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold text-primary">Structure & Main d'Œuvre</label>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Filière</label>
                                <select class="form-select form-select-sm" id="filiere">
                                    <option value="Bovins Lait">Bovins Lait</option>
                                    <option value="Grandes Cultures">Grandes Cultures</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">SAU (ha)</label>
                                <input type="number" class="form-control form-control-sm" id="sau" value="80">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">UMO</label>
                                <input type="number" step="0.1" class="form-control form-control-sm" id="umo" value="2.0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">UGB Totaux</label>
                                <input type="number" class="form-control form-control-sm" id="ugb" value="60">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Nb Vaches Laitières</label>
                                <input type="number" class="form-control form-control-sm" id="nb_vl" value="45">
                            </div>

                            <div class="col-md-12 mt-3">
                                <label class="form-label fw-bold text-primary">Assolement Détaillé (ha)</label>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">SFP (Surf. Fourragère)</label>
                                <input type="number" class="form-control form-control-sm" id="surf_sfp" value="60" onchange="updateRatios()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Herbe (Prairies Perm.)</label>
                                <input type="number" class="form-control form-control-sm" id="surf_pp" value="30">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Herbe (Prairies Temp.)</label>
                                <input type="number" class="form-control form-control-sm" id="surf_pt" value="10">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Cultures Vente</label>
                                <input type="number" class="form-control form-control-sm" id="surf_cult" value="20">
                            </div>

                            <!-- Hidden Calculation Fields (Auto-computed) -->
                            <input type="hidden" id="part_mais" value="30"> 
                            <input type="hidden" id="part_herbe" value="50">

                            <div class="col-md-12 d-flex justify-content-end mt-3">
                                <button type="submit" class="btn btn-primary w-100">Lancer l'Analyse K-Type</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- SIMULATION INTERACTIVE -->
                <div id="simulation-results" style="display:none;">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="text-primary mb-3">Levier Principal : Surface en Herbe</h5>
                            <label class="form-label d-flex justify-content-between">
                                <span>Part d'herbe actuelle : <strong id="current-herbe-disp">50%</strong></span>
                                <span class="text-muted">Cible K-Type : 75%</span>
                            </label>
                            <input type="range" class="form-range" id="simHerbe" min="0" max="100" oninput="updateSimDisplay(this.value)">
                            <div class="d-flex justify-content-between text-muted small">
                                <span>0%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Autonomie Fourragère</h6>
                                    <div class="display-5 fw-bold mb-2" id="sim-autonomy">-- %</div>
                                    <div id="delta-autonomy" class="badge bg-light text-dark">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Empreinte Carbone</h6>
                                    <div class="display-5 fw-bold mb-2" id="sim-carbon">-- tCO2</div>
                                    <div id="delta-carbon" class="badge bg-light text-dark">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- NAVIGATION ---
        function showView(viewId) {
            document.querySelectorAll('#main-content > div').forEach(el => el.style.display = 'none');
            document.querySelectorAll('#sidebar .nav-link').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById('view-' + viewId);
            if(target) target.style.display = viewId === 'simulation' ? 'flex' : 'block';
            
            // Highlight nav
            // (Simple implementation, assumes order matches)
        }

        // --- CHAT LOGIC ---
        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // User Msg
            addMessage(msg, 'user');
            input.value = '';

            // Bot Response (Mocking Backend)
            // In real app: fetch('/chat', { method: 'POST', body: JSON.stringify({ message: msg }) })
            
            // Show "Thinking"
            const thinkingId = addMessage("Analyse en cours...", 'bot', true);

            try {
                const response = await fetch('http://localhost:8000/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg })
                });
                const data = await response.json();
                
                // Remove thinking
                document.getElementById(thinkingId).remove();
                
                // Add structured response
                addStructuredMessage(data);

            } catch (e) {
                console.error(e);
                document.getElementById(thinkingId).innerText = "Erreur de connexion au serveur.";
            }
        }

        function addMessage(text, type, isThinking = false) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-message chat-${type}`;
            div.id = 'msg-' + Date.now();
            
            div.innerHTML = `
                <div class="bubble">
                    ${isThinking ? '<i class="bi bi-three-dots-vertical"></i> ' : ''}${text}
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        function addStructuredMessage(data) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-message chat-bot`;
            
            let reasoningHtml = '';
            if (data.reasoning_steps) {
                reasoningHtml = `<div class="reasoning-steps">
                    ${data.reasoning_steps.map(step => `<div><i class="bi bi-check2"></i> ${step}</div>`).join('')}
                </div>`;
            }

            let sourcesHtml = '';
            if (data.citations) {
                sourcesHtml = `<div class="sources-list">
                    ${data.citations.map(c => `<span class="source-chip" title="${c.title}"><i class="bi bi-file-text"></i> ${c.id}</span>`).join('')}
                </div>`;
            }

            let actionsHtml = '';
            if (data.suggested_actions) {
                actionsHtml = `<div class="mt-2">
                    ${data.suggested_actions.map(a => `<button class="btn btn-sm btn-outline-primary me-2 action-btn">${a.label}</button>`).join('')}
                </div>`;
            }

            div.innerHTML = `
                <div class="bubble">
                    ${reasoningHtml}
                    <div>${data.response}</div>
                    ${sourcesHtml}
                    ${actionsHtml}
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        // --- SIMULATION LOGIC ---
        document.getElementById('farmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Auto-compute ratios from Surfaces
            const sfp = parseFloat(document.getElementById('surf_sfp').value) || 1;
            const pp = parseFloat(document.getElementById('surf_pp').value) || 0;
            const pt = parseFloat(document.getElementById('surf_pt').value) || 0;
            const partHerbe = ((pp + pt) / sfp) * 100;
            const partMais = 100 - partHerbe; // Simplified for demo
            
            const payload = {
                region: "Bretagne", // Default
                filiere: document.getElementById('filiere').value,
                sau: parseFloat(document.getElementById('sau').value),
                umo: parseFloat(document.getElementById('umo').value),
                ugb: parseFloat(document.getElementById('ugb').value),
                nb_vl: parseFloat(document.getElementById('nb_vl').value),
                
                surface_sfp: sfp,
                surface_herbe_pp: pp,
                surface_herbe_pt: pt,
                surface_culture: parseFloat(document.getElementById('surf_cult').value),
                
                part_herbe: partHerbe,
                part_mais: partMais
            };
            
            // Call API
            try {
                const response = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Update Chat with Backend Insight
                    addStructuredMessage({
                        response: `Simulation terminée. Votre système est identifié comme **${data.current_ktype}**.`,
                        reasoning_steps: [
                            `Identification K-Type: ${data.current_ktype}`,
                            `Analyse Autonomie: ${data.current_state.autonomie_fourragere_estimee}%`,
                            `Score Biodiversité: ${data.current_state.biodiversity_score}/10`
                        ],
                        suggested_actions: [{label: "Voir détail technico-éco"}]
                    });
                }
            } catch (err) {
                console.error("Erreur backend:", err);
                // Fallback demo mode if backend is not reachable
                addStructuredMessage({
                    response: `Mode Démo (Backend non détecté). Avec ${payload.umo} UMO et ${payload.nb_vl} VL, votre part d'herbe est de ${Math.round(partHerbe)}%.`,
                    reasoning_steps: ["Calcul local des ratios", "Estimation K-Type théorique"],
                    suggested_actions: [{label: "Réessayer connexion"}]
                });
            }

            document.getElementById('simulation-results').style.display = 'block';
            updateSimDisplay(Math.round(partHerbe));
        });

        function updateSimDisplay(val) {
            document.getElementById('current-herbe-disp').innerText = val + '%';
            // Mock logic
            const autonomy = 40 + (val * 0.4); 
            const carbon = 1200 - (val * 5);
            
            document.getElementById('sim-autonomy').innerText = Math.round(autonomy) + ' %';
            document.getElementById('sim-carbon').innerText = Math.round(carbon) + ' tCO2';
            
            document.getElementById('delta-autonomy').innerText = (val > 50 ? '+' : '') + Math.round((val-50)*0.4) + ' pts';
        }

        // Init
        loadDashboardStats();
        async function loadDashboardStats() {
             try {
                const response = await fetch('http://localhost:8000/advisor/stats');
                const data = await response.json();
                document.getElementById('dash-total-farmers').innerText = data.total_farmers;
                document.getElementById('dash-visits').innerText = data.visits_this_month;
                document.getElementById('dash-carbon').innerText = '-' + data.avg_carbon_reduction_potential + '%';
            } catch(e) {}
        }

    </script>
</body>
</html>
