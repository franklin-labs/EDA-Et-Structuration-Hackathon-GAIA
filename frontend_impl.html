<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTransition - Portail Conseiller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-link { cursor: pointer; }
        .nav-link.active { font-weight: bold; color: #0d6efd !important; }
        .chat-container { height: 400px; overflow-y: auto; background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #e9ecef; }
        .chat-message { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .chat-user { background-color: #0d6efd; color: white; margin-left: auto; }
        .chat-bot { background-color: #e9ecef; color: #212529; margin-right: auto; }
        .stat-card-icon { font-size: 2rem; color: #0d6efd; opacity: 0.8; }
        .feature-icon { width: 4rem; height: 4rem; border-radius: 0.75rem; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-flower1 me-2"></i>AgriTransition <span class="badge bg-secondary ms-2">Conseiller</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" onclick="showView('dashboard')" id="nav-dashboard">Tableau de Bord</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showView('simulation')" id="nav-simulation">Nouvelle Visite / Simulation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showView('chat')" id="nav-chat">Assistant IA</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard">
            <h2 class="mb-4">Bonjour, Conseiller</h2>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-1">Agriculteurs Suivis</h6>
                                <h2 class="mb-0" id="dash-total-farmers">--</h2>
                            </div>
                            <i class="bi bi-people stat-card-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-1">Visites ce mois</h6>
                                <h2 class="mb-0" id="dash-visits">--</h2>
                            </div>
                            <i class="bi bi-calendar-check stat-card-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted text-uppercase mb-1">Potentiel Gain CO2</h6>
                                <h2 class="mb-0" id="dash-carbon">-- %</h2>
                            </div>
                            <i class="bi bi-tree stat-card-icon"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-white fw-bold">Dernières Visites</div>
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Agriculteur</th>
                                        <th>Date</th>
                                        <th>Filière</th>
                                        <th>État</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>GAEC des Lilas</td>
                                        <td>23/02/2026</td>
                                        <td>Bovins Lait</td>
                                        <td><span class="badge bg-warning text-dark">En cours</span></td>
                                        <td><button class="btn btn-sm btn-outline-primary">Voir</button></td>
                                    </tr>
                                    <tr>
                                        <td>Ferme du Val</td>
                                        <td>21/02/2026</td>
                                        <td>Grandes Cultures</td>
                                        <td><span class="badge bg-success">Validé</span></td>
                                        <td><button class="btn btn-sm btn-outline-primary">Voir</button></td>
                                    </tr>
                                    <tr>
                                        <td>EARL Martin</td>
                                        <td>18/02/2026</td>
                                        <td>Polyculture</td>
                                        <td><span class="badge bg-secondary">Archivé</span></td>
                                        <td><button class="btn btn-sm btn-outline-primary">Voir</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-white fw-bold">Actions Prioritaires (Top 3)</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush" id="dash-actions">
                                <!-- Actions inserted via JS -->
                            </ul>
                        </div>
                    </div>
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5>Démarrer une nouvelle visite</h5>
                            <p class="small">Lancer le simulateur pour un nouvel agriculteur</p>
                            <button class="btn btn-light text-primary fw-bold w-100" onclick="showView('simulation')">Lancer Simulation</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: SIMULATION (Existing logic adapted) -->
        <div id="view-simulation" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Simulateur de Transition</h2>
                <button class="btn btn-outline-secondary" onclick="showView('dashboard')"><i class="bi bi-arrow-left me-1"></i>Retour Dashboard</button>
            </div>

            <div class="row">
                <!-- Formulaire -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-input-cursor-text me-2"></i>Données Exploitation
                        </div>
                        <div class="card-body">
                            <form id="farmForm">
                                <div class="mb-3">
                                    <label class="form-label">Région</label>
                                    <select class="form-select" id="region">
                                        <option value="Bretagne">Bretagne</option>
                                        <option value="Normandie">Normandie</option>
                                        <option value="Pays de la Loire">Pays de la Loire</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Filière</label>
                                    <select class="form-select" id="filiere">
                                        <option value="Bovins Lait">Bovins Lait</option>
                                        <option value="Grandes Cultures">Grandes Cultures</option>
                                        <option value="Polyculture-Élevage">Polyculture-Élevage</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">SAU (ha)</label>
                                        <input type="number" class="form-control" id="sau" value="80">
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">UGB Total</label>
                                        <input type="number" class="form-control" id="ugb" value="60">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Part Maïs SFP (%)</label>
                                    <input type="number" class="form-control" id="part_mais" value="30">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Part Herbe SFP (%)</label>
                                    <input type="number" class="form-control" id="part_herbe" value="50">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Initialiser Situation</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Résultats -->
                <div class="col-md-8">
                    <!-- Section Simulation Interactive (Hidden initially) -->
                    <div id="simulation-panel" style="display:none;">
                        <div class="card mb-4 border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary"><i class="bi bi-sliders me-2"></i>Simulation "What-If" : Part d'Herbe</h5>
                                <p class="text-muted small">Ajustez le curseur pour voir l'impact systémique immédiat.</p>
                                
                                <div class="d-flex align-items-center">
                                    <span class="me-2 fw-bold text-muted">0%</span>
                                    <input type="range" class="form-range" id="simHerbe" min="0" max="100">
                                    <span class="ms-2 fw-bold text-muted">100%</span>
                                </div>
                                <div class="text-center mt-2">
                                    <span class="badge bg-primary fs-5" id="simHerbeValue">50%</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Situation Actuelle -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header text-center fw-bold">Situation Actuelle</div>
                                    <div class="card-body text-center">
                                        <h1 class="display-6" id="res-autonomy">-- %</h1>
                                        <p class="text-muted">Autonomie Fourragère</p>
                                        <hr>
                                        <h3 id="res-carbon">-- tCO2e</h3>
                                        <p class="text-muted">Empreinte Carbone</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Situation Simulée -->
                            <div class="col-md-6">
                                <div class="card h-100 border-success" id="sim-card">
                                    <div class="card-header bg-success text-white text-center fw-bold">Projection Simulée</div>
                                    <div class="card-body text-center">
                                        <h1 class="display-6" id="sim-autonomy">-- %</h1>
                                        <p class="text-muted">Autonomie Fourragère</p>
                                        <hr>
                                        <h3 id="sim-carbon">-- tCO2e</h3>
                                        <p class="text-muted">Empreinte Carbone</p>
                                        <div id="sim-deltas" class="mt-3">
                                            <!-- Deltas added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-4">
                            <div class="card-header bg-warning text-dark fw-bold">
                                <i class="bi bi-lightbulb me-2"></i>Analyse de l'Assistant
                            </div>
                            <div class="card-body">
                                <ul id="recommendations-list"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <div id="initial-placeholder" class="text-center text-muted mt-5">
                        <i class="bi bi-arrow-left-circle display-4"></i>
                        <p class="mt-3">Veuillez valider les données de l'exploitation pour commencer.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CHAT -->
        <div id="view-chat" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Assistant IA Expert</h2>
                        <span class="badge bg-success">Connecté</span>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div id="chat-history" class="chat-container mb-3">
                                <div class="chat-message chat-bot">
                                    Bonjour ! Je suis votre assistant expert en transition agro-écologique. Je peux vous aider sur les aspects techniques, réglementaires ou sur l'utilisation du simulateur.
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <input type="text" id="chat-input" class="form-control" placeholder="Posez votre question (ex: Quelles aides pour la plantation de haies ?)...">
                                <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                    <i class="bi bi-send-fill"></i> Envoyer
                                </button>
                            </div>
                            <div id="chat-suggestions" class="mt-2">
                                <!-- Suggestions buttons -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let currentFarmData = null;

        // Navigation
        function showView(viewId) {
            // Hide all
            document.getElementById('view-dashboard').style.display = 'none';
            document.getElementById('view-simulation').style.display = 'none';
            document.getElementById('view-chat').style.display = 'none';
            
            // Deactivate nav links
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById('view-' + viewId).style.display = 'block';
            document.getElementById('nav-' + viewId).classList.add('active');

            if(viewId === 'dashboard') loadDashboardStats();
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboardStats() {
            try {
                const response = await fetch('http://localhost:8000/advisor/stats');
                const data = await response.json();
                
                document.getElementById('dash-total-farmers').innerText = data.total_farmers;
                document.getElementById('dash-visits').innerText = data.visits_this_month;
                document.getElementById('dash-carbon').innerText = '-' + data.avg_carbon_reduction_potential + '%';
                
                const list = document.getElementById('dash-actions');
                list.innerHTML = '';
                data.top_actions.forEach(action => {
                    list.innerHTML += `<li class="list-group-item"><i class="bi bi-check-circle text-success me-2"></i>${action}</li>`;
                });
            } catch (e) {
                console.error("Error loading stats", e);
            }
        }

        // --- SIMULATION LOGIC ---
        document.getElementById('farmForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 1. Build Farm Input Object
            currentFarmData = {
                region: document.getElementById('region').value,
                filiere: document.getElementById('filiere').value,
                sau: parseFloat(document.getElementById('sau').value),
                ugb: parseFloat(document.getElementById('ugb').value),
                part_mais: parseFloat(document.getElementById('part_mais').value),
                part_herbe: parseFloat(document.getElementById('part_herbe').value)
            };

            // 2. Call API to get Initial State
            await runSimulation();

            // 3. Show Simulation UI
            document.getElementById('initial-placeholder').style.display = 'none';
            document.getElementById('simulation-panel').style.display = 'block';
            
            // Init Slider
            const slider = document.getElementById('simHerbe');
            slider.value = currentFarmData.part_herbe;
            document.getElementById('simHerbeValue').innerText = slider.value + '%';
        });

        // Real-time Slider Simulation
        document.getElementById('simHerbe').addEventListener('input', function(e) {
            document.getElementById('simHerbeValue').innerText = e.target.value + '%';
        });
        
        document.getElementById('simHerbe').addEventListener('change', async function(e) {
             await runSimulation(parseFloat(e.target.value));
        });

        async function runSimulation(targetHerbe = null) {
            let url = 'http://localhost:8000/simulate';
            if (targetHerbe !== null) {
                url += `?target_part_herbe=${targetHerbe}`;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentFarmData)
                });
                
                const result = await response.json();
                
                // Update Current State Display
                document.getElementById('res-autonomy').innerText = result.current_state.autonomie_fourragere_estimee + '%';
                document.getElementById('res-carbon').innerText = result.current_state.carbon_footprint + ' t';

                // Update Simulated State Display (if active)
                if (result.simulated_state) {
                    document.getElementById('sim-autonomy').innerText = result.simulated_state.autonomie_fourragere_estimee + '%';
                    document.getElementById('sim-carbon').innerText = result.simulated_state.carbon_footprint + ' t';
                    
                    // Deltas
                    let deltaHtml = '';
                    if (result.delta_autonomy > 0) deltaHtml += `<span class="badge bg-success me-1">+${result.delta_autonomy} Autonomie</span>`;
                    if (result.delta_carbon < 0) deltaHtml += `<span class="badge bg-success me-1">${result.delta_carbon} tCO2e</span>`;
                    else if (result.delta_carbon > 0) deltaHtml += `<span class="badge bg-danger me-1">+${result.delta_carbon} tCO2e</span>`;
                    
                    document.getElementById('sim-deltas').innerHTML = deltaHtml;
                } else {
                    // Reset simulated view to match current if no target
                     document.getElementById('sim-autonomy').innerText = result.current_state.autonomie_fourragere_estimee + '%';
                     document.getElementById('sim-carbon').innerText = result.current_state.carbon_footprint + ' t';
                     document.getElementById('sim-deltas').innerHTML = '<span class="text-muted">Déplacez le curseur pour simuler</span>';
                }

                // Recommendations
                const recList = document.getElementById('recommendations-list');
                recList.innerHTML = '';
                if (result.recommendations && result.recommendations.length > 0) {
                    result.recommendations.forEach(rec => {
                        recList.innerHTML += `<li>${rec}</li>`;
                    });
                } else {
                    recList.innerHTML = '<li><em>Aucune recommandation spécifique pour ce scénario.</em></li>';
                }

            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la simulation. Vérifiez que le backend tourne.');
            }
        }

        // --- CHAT LOGIC ---
        async function sendMessage(text = null) {
            const inputEl = document.getElementById('chat-input');
            const message = text || inputEl.value;
            if (!message) return;

            // Add User Message
            addChatMessage(message, 'user');
            inputEl.value = '';

            try {
                const response = await fetch('http://localhost:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        context: currentFarmData // Pass current farm context if available
                    })
                });
                const data = await response.json();
                
                // Add Bot Response
                addChatMessage(data.response, 'bot');
                
                // Show suggestions
                const suggDiv = document.getElementById('chat-suggestions');
                suggDiv.innerHTML = '';
                if(data.suggested_actions) {
                    data.suggested_actions.forEach(act => {
                        suggDiv.innerHTML += `<button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="sendMessage('${act}')">${act}</button>`;
                    });
                }

            } catch (e) {
                addChatMessage("Désolé, je ne peux pas répondre pour le moment.", 'bot');
            }
        }

        function addChatMessage(text, sender) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-message chat-${sender}`;
            div.innerText = text;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        // Init
        loadDashboardStats();
    </script>
</body>
</html>
