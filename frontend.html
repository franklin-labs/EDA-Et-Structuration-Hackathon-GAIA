
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTransition - Assistant de Transition Écologique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-custom {
            transition: transform 0.3s;
        }
        .card-custom:hover {
            transform: translateY(-5px);
        }
        .bg-gradient-success {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            color: white;
        }
        .step-indicator {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            text-align: center;
            margin-right: 10px;
            font-weight: bold;
        }
        .step-active {
            background-color: #198754;
            color: white;
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
        <a class="navbar-brand" href="#">AgriTransition AI</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</nav>

<div class="container mt-5">
    <div class="row">
        <!-- Input Form -->
        <div class="col-md-5 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><span class="step-indicator step-active">1</span>Données de l'Exploitation</h5>
                </div>
                <div class="card-body">
                    <form id="farmForm">
                        <div class="mb-3">
                            <label for="otex" class="form-label">Orientation (OTEX)</label>
                            <select class="form-select" id="otex" required>
                                <option value="Bovins Lait">Bovins Lait</option>
                                <option value="Bovins Viande">Bovins Viande</option>
                                <option value="Grandes Cultures">Grandes Cultures</option>
                                <option value="Polyculture-Élevage">Polyculture-Élevage</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="region" class="form-label">Région</label>
                            <select class="form-select" id="region" required>
                                <option value="Bretagne">Bretagne</option>
                                <option value="Normandie">Normandie</option>
                                <option value="Pays de la Loire">Pays de la Loire</option>
                                <option value="Auvergne-Rhône-Alpes">Auvergne-Rhône-Alpes</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="sau" class="form-label">Surface (SAU en ha)</label>
                                <input type="number" class="form-control" id="sau" placeholder="ex: 80" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ugb" class="form-label">Cheptel (UGB)</label>
                                <input type="number" class="form-control" id="ugb" placeholder="ex: 60" required>
                            </div>
                        </div>
                        <hr>
                        <h6>Indicateurs Clés (Optionnel)</h6>
                        <div class="mb-3">
                            <label for="chargement" class="form-label">Chargement (UGB/ha SFP)</label>
                            <input type="number" step="0.1" class="form-control" id="chargement" placeholder="ex: 1.4">
                        </div>
                        <div class="mb-3">
                            <label for="mais" class="form-label">Part Maïs Ensilage (% SFP)</label>
                            <input type="number" class="form-control" id="mais" placeholder="ex: 30">
                        </div>
                        <div class="mb-3">
                            <label for="autonomie" class="form-label">Autonomie Fourragère (%)</label>
                            <input type="number" class="form-control" id="autonomie" placeholder="ex: 65">
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 py-2">Lancer la Simulation</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div class="col-md-7">
            <div id="resultsCard" class="card shadow-sm d-none">
                <div class="card-header bg-gradient-success">
                    <h5 class="mb-0"><span class="step-indicator bg-white text-success">2</span>Résultats & Recommandations</h5>
                </div>
                <div class="card-body">
                    <!-- Score & K-Type -->
                    <div class="row text-center mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Profil Actuel</h6>
                            <h4 id="currentKType" class="text-primary fw-bold">-</h4>
                        </div>
                        <div class="col-md-6 border-start">
                            <h6 class="text-muted">Objectif Cible</h6>
                            <h4 id="targetKType" class="text-success fw-bold">-</h4>
                        </div>
                    </div>

                    <!-- Metrics -->
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="p-3 border rounded bg-light text-center">
                                <small class="text-muted d-block">Score de Viabilité Transition</small>
                                <span id="transitionScore" class="display-6 fw-bold text-success">-</span><span class="fs-5">/100</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded bg-light text-center">
                                <small class="text-muted d-block">Gain Carbone Potentiel</small>
                                <span id="carbonGain" class="display-6 fw-bold text-primary">-</span><span class="fs-5"> tCO2e</span>
                            </div>
                        </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Actions Recommandées</h5>
                    <div id="recommendationsList">
                        <!-- JS will inject cards here -->
                    </div>

                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5 d-none">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Analyse de votre exploitation en cours...</p>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5">
                <img src="https://cdn-icons-png.flaticon.com/512/628/628283.png" width="100" class="mb-3 opacity-50">
                <h5 class="text-muted">Remplissez le formulaire pour obtenir votre diagnostic</h5>
                <p class="text-muted small">Vos données sont analysées localement pour vous proposer le meilleur parcours de transition.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('farmForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // UI State
    document.getElementById('emptyState').classList.add('d-none');
    document.getElementById('resultsCard').classList.add('d-none');
    document.getElementById('loadingState').classList.remove('d-none');
    
    // Prepare Payload
    const payload = {
        region: document.getElementById('region').value,
        otex: document.getElementById('otex').value,
        sau: parseFloat(document.getElementById('sau').value),
        ugb: parseFloat(document.getElementById('ugb').value),
        chargement: document.getElementById('chargement').value ? parseFloat(document.getElementById('chargement').value) : null,
        part_maïs: document.getElementById('mais').value ? parseFloat(document.getElementById('mais').value) : 0,
        autonomie_fourragère: document.getElementById('autonomie').value ? parseFloat(document.getElementById('autonomie').value) : null
    };

    try {
        const response = await fetch('http://localhost:8000/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        // Update UI
        document.getElementById('currentKType').innerText = data.current_ktype;
        document.getElementById('targetKType').innerText = data.target_ktype;
        document.getElementById('transitionScore').innerText = data.transition_score;
        
        const gain = (data.carbon_footprint_current - data.carbon_footprint_target).toFixed(1);
        document.getElementById('carbonGain').innerText = gain > 0 ? `-${gain}` : "0";
        
        // Render Recommendations
        const recList = document.getElementById('recommendationsList');
        recList.innerHTML = '';
        
        data.recommendations.forEach(rec => {
            const badgeClass = rec.category === 'Environment' ? 'bg-success' : (rec.category === 'Economic' ? 'bg-primary' : 'bg-info');
            const html = `
                <div class="card card-custom mb-3 border-start border-4 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title fw-bold mb-0">${rec.title}</h6>
                            <span class="badge ${badgeClass}">${rec.category}</span>
                        </div>
                        <p class="card-text text-muted small mb-2">${rec.description}</p>
                        <div class="d-flex gap-3">
                            <small class="text-muted">Impact: <strong>${'★'.repeat(rec.impact_score)}</strong></small>
                            <small class="text-muted">Coût: <strong>${'€'.repeat(rec.cost_score)}</strong></small>
                        </div>
                    </div>
                </div>
            `;
            recList.innerHTML += html;
        });

        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('resultsCard').classList.remove('d-none');
        
    } catch (error) {
        console.error('Error:', error);
        alert("Erreur lors de la connexion au serveur. Vérifiez que le backend FastAPI tourne sur le port 8000.");
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('emptyState').classList.remove('d-none');
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
